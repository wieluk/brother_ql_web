name: Build & Push Docker images to GHCR

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  delete:
    branches: ["**"]
  workflow_dispatch: {}

env:
  IMAGE_NAME: ghcr.io/wieluk/brother-ql-web

jobs:
  build_and_push:
    name: Build & push (branch/master/tag)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute docker tag(s)
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="${IMAGE_NAME}"
          TAGS=""

          # Converts git refs to safe docker tags.
          # - lowercases
          # - replaces anything not [a-z0-9_.-] with '-'
          # - trims leading/trailing separators
          # - collapses multiple '-' (optional)
          sanitize() {
            echo "$1" \
              | tr '[:upper:]' '[:lower:]' \
              | sed -E 's/[^a-z0-9_.-]+/-/g; s/^-+//; s/-+$//; s/-+/-/g'
          }

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            # Release tag (v*)
            REF_TAG="${GITHUB_REF_NAME}"
            SAFE_TAG="$(sanitize "$REF_TAG")"
            TAGS="${IMAGE}:${SAFE_TAG}"
            echo "mode=tag" >> "$GITHUB_OUTPUT"

          elif [[ "${GITHUB_REF_TYPE}" == "branch" ]]; then
            BRANCH="${GITHUB_REF_NAME}"

            if [[ "${BRANCH}" == "master" ]]; then
              TAGS="${IMAGE}:latest"
              echo "mode=master" >> "$GITHUB_OUTPUT"
            else
              SAFE_BRANCH="$(sanitize "$BRANCH")"
              TAGS="${IMAGE}:${SAFE_BRANCH}"
              echo "mode=branch" >> "$GITHUB_OUTPUT"
              echo "branch_tag=${SAFE_BRANCH}" >> "$GITHUB_OUTPUT"
            fi
          fi

          echo "tags=${TAGS}" >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"

      - name: Build & push
        if: steps.meta.outputs.tags != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Keep only one version per branch-tag by deleting older versions that also have that tag.
      # (GHCR stores immutable "versions"; retagging creates a new version, the old one still exists
      # and still lists the tag unless cleaned up.)
      - name: Keep only latest version for this branch tag
        if: steps.meta.outputs.mode == 'branch'
        env:
          ORG: wieluk
          PACKAGE: brother-ql-web
          TAG: ${{ steps.meta.outputs.branch_tag }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gh jq

          # Get all versions that have TAG, newest first, keep the first one.
          IDS=$(gh api "/orgs/${ORG}/packages/container/${PACKAGE}/versions" --paginate \
            | jq -r --arg t "$TAG" '
                sort_by(.created_at) | reverse
                | map(select(.metadata.container.tags[]? == $t) | .id) | .[]
              ')

          KEEP="$(echo "$IDS" | head -n1 || true)"
          DELETE="$(echo "$IDS" | tail -n +2 || true)"

          echo "Keeping version: ${KEEP:-<none>}"
          if [[ -n "${DELETE}" ]]; then
            while read -r id; do
              [[ -z "$id" ]] && continue
              echo "Deleting old version id=$id for tag=$TAG"
              gh api -X DELETE "/orgs/${ORG}/packages/container/${PACKAGE}/versions/${id}"
            done <<< "$DELETE"
          else
            echo "No old versions to delete for tag=$TAG"
          fi

  cleanup_deleted_branch:
    name: Delete image when branch is deleted
    if: github.event_name == 'delete' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Compute tag from deleted branch name
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          sanitize() {
            echo "$1" \
              | tr '[:upper:]' '[:lower:]' \
              | sed -E 's/[^a-z0-9_.-]+/-/g; s/^-+//; s/-+$//; s/-+/-/g'
          }

          BRANCH="${{ github.event.ref }}"
          # Don't delete latest on master deletion scenarios (usually not applicable, but safe)
          if [[ "$BRANCH" == "master" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SAFE_BRANCH="$(sanitize "$BRANCH")"
          echo "tag=${SAFE_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Delete all package versions that contain this branch tag
        if: steps.meta.outputs.skip != 'true'
        env:
          ORG: wieluk
          PACKAGE: brother-ql-web
          TAG: ${{ steps.meta.outputs.tag }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gh jq

          IDS=$(gh api "/orgs/${ORG}/packages/container/${PACKAGE}/versions" --paginate \
            | jq -r --arg t "$TAG" '
                map(select(.metadata.container.tags[]? == $t) | .id) | .[]
              ')

          if [[ -z "${IDS}" ]]; then
            echo "No versions found for tag=$TAG"
            exit 0
          fi

          while read -r id; do
            [[ -z "$id" ]] && continue
            echo "Deleting version id=$id for deleted branch tag=$TAG"
            gh api -X DELETE "/orgs/${ORG}/packages/container/${PACKAGE}/versions/${id}"
          done <<< "$IDS"